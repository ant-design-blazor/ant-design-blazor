@using AntDesign.Core.JsInterop.Modules.Components;
@inherits AntDesignTestBase
@code {

    public Select_IME_Tests()
    {
        JSInterop.Setup<AntDesign.JsInterop.DomRect>(JSInteropConstants.GetBoundingClientRect, _ => true)
            .SetResult(new AntDesign.JsInterop.DomRect());
        JSInterop.Setup<AntDesign.JsInterop.HtmlElement>(JSInteropConstants.GetDomInfo, _ => true)
            .SetResult(new AntDesign.JsInterop.HtmlElement());

        JSInterop.SetupVoid(JSInteropConstants.AddPreventKeys, _ => true);
        JSInterop.SetupVoid(JSInteropConstants.AddElementTo, _ => true);
        JSInterop.Setup<OverlayPosition>(JSInteropConstants.OverlayComponentHelper.AddOverlayToContainer, _ => true)
            .SetResult(new OverlayPosition() { Top = 0, Left = 0, ZIndex = 5000, Placement = Placement.BottomLeft });
#if !NET6_0_OR_GREATER
#pragma warning disable CS0618 // Type or member is obsolete
        JSInterop.SetupVoid(JSInteropConstants.Focus, _ => true).SetVoidResult();
#pragma warning restore CS0618 // Type or member is obsolete
#endif
    }

    /// <summary>
    /// Test: When IME composition is in progress and user presses BACKSPACE,
    /// it should NOT remove selected items, but should allow IME to handle the backspace.
    /// </summary>
    [Fact]
    public async Task Backspace_During_IME_Composition_Should_Not_Remove_Selected_Items()
    {
        //Arrange
        var selectedValues = new List<string> { "Lucy", "John" };
        var dataSource = new List<string> { "Lucy", "John", "Jack", "Emily" };
        
        var cut = Render<AntDesign.Select<string, string>>(
            @<AntDesign.Select Mode="SelectMode.Multiple"
                TItemValue="string"
                TItem="string"
                EnableSearch
                SearchDebounceMilliseconds="0"
                Values="@selectedValues"
                DataSource="@dataSource" />
        );

        var input = cut.Find("input.ant-select-selection-search-input");
        
        // Verify initial state - should have 2 selected items
        cut.Instance.SelectedOptionItems.Should().HaveCount(2);
        
        // Simulate IME composition start (e.g., user starts typing Chinese)
        var selectContent = cut.Instance.GetType()
            .GetField("_selectContent", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)
            ?.GetValue(cut.Instance);
        
        if (selectContent != null)
        {
            // Trigger composition start
            var compositionStartMethod = selectContent.GetType()
                .GetMethod("OnCompositionStart", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (compositionStartMethod != null)
            {
                await cut.InvokeAsync(() => 
                {
                    compositionStartMethod.Invoke(selectContent, new object[] { System.Text.Json.JsonDocument.Parse("{}").RootElement });
                });
            }
        }

        // Act: Press BACKSPACE during IME composition
        await cut.InvokeAsync(() => input.KeyUp(new KeyboardEventArgs { Key = "Backspace" }));
        
        // Assert: Selected items should NOT be removed
        cut.Instance.SelectedOptionItems.Should().HaveCount(2, 
            "selected items should not be removed when backspace is pressed during IME composition");
        cut.Instance.SelectedOptionItems.Select(x => x.Value).Should().ContainInOrder("Lucy", "John");
    }

    /// <summary>
    /// Test: When IME composition is NOT in progress and user presses BACKSPACE with empty search,
    /// it should remove the last selected item (existing behavior).
    /// </summary>
    [Fact]
    public async Task Backspace_Without_IME_Composition_Should_Remove_Last_Selected_Item()
    {
        //Arrange
        var selectedValues = new List<string> { "Lucy", "John" };
        var dataSource = new List<string> { "Lucy", "John", "Jack", "Emily" };
        
        var cut = Render<AntDesign.Select<string, string>>(
            @<AntDesign.Select Mode="SelectMode.Multiple"
                TItemValue="string"
                TItem="string"
                EnableSearch
                SearchDebounceMilliseconds="0"
                Values="@selectedValues"
                DataSource="@dataSource" />
        );

        var input = cut.Find("input.ant-select-selection-search-input");
        
        // Verify initial state - should have 2 selected items
        cut.Instance.SelectedOptionItems.Should().HaveCount(2);

        // Act: Press BACKSPACE without IME composition
        await cut.InvokeAsync(() => input.KeyUp(new KeyboardEventArgs { Key = "Backspace" }));
        
        // Assert: Last selected item should be removed
        cut.WaitForAssertion(() => cut.Instance.SelectedOptionItems.Should().HaveCount(1, 
            "last selected item should be removed when backspace is pressed without IME composition"));
        cut.Instance.SelectedOptionItems.First().Value.Should().Be("Lucy");
    }

    /// <summary>
    /// Test: When IME composition ends and user presses BACKSPACE,
    /// it should remove selected items (normal behavior after composition).
    /// </summary>
    [Fact]
    public async Task Backspace_After_IME_Composition_Ends_Should_Remove_Selected_Item()
    {
        //Arrange
        var selectedValues = new List<string> { "Lucy", "John" };
        var dataSource = new List<string> { "Lucy", "John", "Jack", "Emily" };
        
        var cut = Render<AntDesign.Select<string, string>>(
            @<AntDesign.Select Mode="SelectMode.Multiple"
                TItemValue="string"
                TItem="string"
                EnableSearch
                SearchDebounceMilliseconds="0"
                Values="@selectedValues"
                DataSource="@dataSource" />
        );

        var input = cut.Find("input.ant-select-selection-search-input");
        
        // Verify initial state
        cut.Instance.SelectedOptionItems.Should().HaveCount(2);

        var selectContent = cut.Instance.GetType()
            .GetField("_selectContent", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)
            ?.GetValue(cut.Instance);
        
        if (selectContent != null)
        {
            // Start IME composition
            var compositionStartMethod = selectContent.GetType()
                .GetMethod("OnCompositionStart", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (compositionStartMethod != null)
            {
                await cut.InvokeAsync(() => 
                {
                    compositionStartMethod.Invoke(selectContent, new object[] { System.Text.Json.JsonDocument.Parse("{}").RootElement });
                });
            }

            // End IME composition
            var compositionEndMethod = selectContent.GetType()
                .GetMethod("OnCompositionEndAsync", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (compositionEndMethod != null)
            {
                await cut.InvokeAsync(async () => 
                {
                    var task = compositionEndMethod.Invoke(selectContent, new object[] { System.Text.Json.JsonDocument.Parse("{}").RootElement });
                    if (task is Task taskResult)
                    {
                        await taskResult;
                    }
                });
            }
        }

        // Act: Press BACKSPACE after IME composition ends
        await cut.InvokeAsync(() => input.KeyUp(new KeyboardEventArgs { Key = "Backspace" }));
        
        // Assert: Last selected item should be removed
        cut.WaitForAssertion(() => cut.Instance.SelectedOptionItems.Should().HaveCount(1, 
            "last selected item should be removed when backspace is pressed after IME composition ends"));
        cut.Instance.SelectedOptionItems.First().Value.Should().Be("Lucy");
    }

    /// <summary>
    /// Test: In Tags mode, during IME composition with BACKSPACE,
    /// it should not remove selected tags.
    /// </summary>
    [Fact]
    public async Task Tags_Mode_Backspace_During_IME_Should_Not_Remove_Tags()
    {
        //Arrange
        var selectedValues = new List<string> { "Tag1", "Tag2", "Tag3" };
        
        var cut = Render<AntDesign.Select<string, string>>(
            @<AntDesign.Select Mode="SelectMode.Tags"
                TItemValue="string"
                TItem="string"
                SearchDebounceMilliseconds="0"
                Values="@selectedValues">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value=@("Tag1") Label="Tag1" />
                    <SelectOption TItemValue="string" TItem="string" Value=@("Tag2") Label="Tag2" />
                    <SelectOption TItemValue="string" TItem="string" Value=@("Tag3") Label="Tag3" />
                </SelectOptions>
            </AntDesign.Select>
        );

        var input = cut.Find("input.ant-select-selection-search-input");
        
        // Verify initial state
        cut.Instance.SelectedOptionItems.Should().HaveCount(3);

        var selectContent = cut.Instance.GetType()
            .GetField("_selectContent", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)
            ?.GetValue(cut.Instance);
        
        if (selectContent != null)
        {
            // Start IME composition
            var compositionStartMethod = selectContent.GetType()
                .GetMethod("OnCompositionStart", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (compositionStartMethod != null)
            {
                await cut.InvokeAsync(() => 
                {
                    compositionStartMethod.Invoke(selectContent, new object[] { System.Text.Json.JsonDocument.Parse("{}").RootElement });
                });
            }
        }

        // Act: Press BACKSPACE during IME composition
        await cut.InvokeAsync(() => input.KeyUp(new KeyboardEventArgs { Key = "Backspace" }));
        
        // Assert: Tags should NOT be removed
        cut.Instance.SelectedOptionItems.Should().HaveCount(3, 
            "tags should not be removed when backspace is pressed during IME composition");
    }
}

